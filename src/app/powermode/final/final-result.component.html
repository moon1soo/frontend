<form ngNoForm name="excelDownFinalForm" action="{{excelUrl}}" target="_blank" method="POST" #excelDownFinalForm>
    <input type="hidden" name="fileName" value="{{exFileName}}">
    <input type="hidden" name="filePath" value="{{exFilePath}}">
    <button type="submit" id="btn-submit-powermode-final-excel" onclick="excelDownFinalForm.submit()" hidden>Download</button>
</form>

<div class="container-header powermode m-3">
    <h4 class="h6">
        {{'renewal2017.finalResultTable' | translate}}
        <!-- <span *ngIf="totalCount !== null">
            {{'renewal2017.p.patient' | translate}} <strong>{{totalCount}}</strong> {{'common.cnt' | translate}}
        </span> -->
    </h4>
    <div class="row">
        <div class="col-8 row final-row">
            <div class="text-left col-sm-9">
                <ngb-progressbar class="final-bar" type="info" [value]="progressRate">
                    <span *ngIf="progressRate > 0" class="progress-text"> {{ progressRate }} %</span>
                </ngb-progressbar>                                                     
            </div>
            <div class="col-sm-3 text-center">
                <span>{{'renewal2017.p.left-time' | translate}} : {{ progressLeft }}</span>
            </div>
        </div>
        <div class="col-4 text-right">
            <!-- Tansepose -->
            <div ngbDropdown class="d-inline-block">
                <button type="button" class="btn btn-light btn-md btn-rounded" id="transpose" ngbDropdownToggle [disabled]="!activeExcel">
                    <i class="fal fa-exchange" aria-hidden="true"></i>
                    {{'renewal2017.transpose.title' | translate}}
                </button>
                <div ngbDropdownMenu aria-labelledby="transpose">
                        <div
                        ngbTooltip="검사에서 검사시행일, 검사세부항목명, 검사결과를 선택해야 합니다."
                        triggers="mouseenter:mouseleave"
                        container="header"
                        placement="left">
                        <button 
                            class="dropdown-item" 
                            (click)="openTranspose('exam')" 
                            [disabled]="!examTranspose">
                            {{'research.examination.0' | translate}}
                        </button>
                    </div>
                    <div
                        ngbTooltip="병리 검사에서 검사시행일, 병리검사결과-KEY, 병리검사결과-VALUE를 선택해야 합니다."
                        triggers="mouseenter:mouseleave"
                        container="header"
                        placement="left">              
                        <button 
                            class="dropdown-item" 
                            (click)="openTranspose('pathology')" 
                            [disabled]="!pathTranspose">
                            {{'renewal2017.pathology.title' | translate}}
                        </button>
                    </div>
                    <div
                        ngbTooltip="서식에서 서식작성일, 서식항목명, 서식내용을 선택해야 합니다."
                        triggers="mouseenter:mouseleave"
                        container="header"
                        placement="left"> 
                        <button 
                            class="dropdown-item" 
                            (click)="openTranspose('form')" 
                            [disabled]="!formTranspose">
                            {{'research.form.0' | translate}}
                        </button>
                    </div>
                    <div
                        ngbTooltip="약품에서 약품명(일반명)을 선택해야 합니다."
                        triggers="mouseenter:mouseleave"
                        container="header"
                        placement="left">
                        <button 
                            class="dropdown-item" 
                            (click)="openTranspose('medicine')" 
                            [disabled]="!mdcnTranspose">
                            {{'research.drug.0' | translate}}
                        </button>
                    </div>
                </div>
            </div>
            <!-- 엑셀 다운로드 -->
            <button type="button" class="btn btn-light btn-md btn-rounded" (click)="excelDownModal()" [disabled]="!activeExcel">
                <i class="fal fa-file-excel-o" aria-hidden="true"></i>
                {{'renewal2017.excelDownload' | translate}}
            </button>    
            <!-- sql viewer -->
            <button type="button" class="btn btn-light btn-md btn-rounded" (click)="sqlViewer()" [disabled]="!sqlStr" [hidden]="!isAdmin">
                <i class="fal fa-file-text" aria-hidden="true"></i>
                {{'renewal2017.sqlViewer' | translate}}
            </button>
        </div> 
    </div>
    <div class="text-left mt-2">
        <span *ngIf="totalCount"><b>{{totalCountStr}}</b> {{'common.cnt' | translate}}</span>
        <span *ngIf="totalCount && !completeFinal">{{'renewal2017.search' | translate}} </span>
        <span *ngIf="totalCount">{{'renewal2017.ing' | translate}} <b>{{displayCount}}</b> {{'common.cnt' | translate}} {{'renewal2017.print' | translate}}</span>
        <button *ngIf="totalCount" 
            type="button"
            class="btn btn-primary btn-xs btn-rounded ml-1" 
            (click)="loadData(null)" 
            [disabled]="loadComplete">
            <i class="fal fa-search-plus" aria-hidden="true"></i>
            Show More
        </button>
        <span *ngIf="!totalCount && completeFinal">{{'renewal2017.p.search-no-render-text' | translate}}</span>
    </div>  
</div>

<div id="powermodeFinalResult" class="relative-area patient-list-overflow px-2">
    <dx-data-grid
        id="power-final-result"
        class="gridContainer-powermode-final resultGrid mx-2"
        [dataSource]="tableSource"
        [width]="gridWidth"
        [columns]="columns"
        [columnResizingMode]="'nextColumn'" 
        [allowColumnResizing]="true"
        [rowAlternationEnabled]="true"
        (onContentReady)="onContentReady($event)"
        (onRowClick)="onRowClick($event)">
        <dxo-selection mode="single"></dxo-selection>
        <dxo-scrolling mode="virtual"></dxo-scrolling>
        <dxo-sorting mode="single"></dxo-sorting>
        <!-- <div *dxTemplate="let data of 'totalCount'">            
            <div class="informer">
                {{'research.search.result.0' | translate}}: <strong>{{totalCount}}</strong>{{'common.cnt' | translate}}
            </div>
        </div> -->
    </dx-data-grid>

    <dx-load-panel
        #loadPanel
        shadingColor="rgba(255,255,255,0)"
        [position]="{ of: '#powermodeFinalResult' }"
        [(visible)]="loading"
        [showIndicator]="true"
        [showPane]="true"
        [shading]="true"
        [closeOnOutsideClick]="false">
    </dx-load-panel>
</div>

    
